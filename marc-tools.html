<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MARC Tools</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    /* Tab style */
    .tabs { display: flex; margin-bottom: 20px; }
    .tab { padding: 10px; cursor: pointer; border: 1px solid #ccc; margin-right: 5px; }
    .tab.active { background-color: #f1f1f1; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* MARC Builder styles */
    .builder-container { display: flex; gap: 5px; margin-bottom: 20px; }
    .builder-input { width: 22%; padding: 5px; font-size: 16px; }
    .dropdown { cursor: pointer; padding: 5px; border: 1px solid #ccc; background: #f9f9f9; text-align: center; width: 40px; }
    .dropdown-menu { display: none; position: absolute; background: white; border: 1px solid #ccc; z-index: 10; }
    .dropdown-menu div { padding: 5px; cursor: pointer; }
    .dropdown-menu div:hover { background: #eee; }
    .results { margin-top: 20px; }
    .result-item { padding: 5px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
    .more-info { cursor: pointer; color: blue; text-decoration: underline; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; width: 60%; max-height: 80vh; overflow-y: auto; position: relative; }
    .modal h3 { margin-top: 0; }
    .modal p { margin: 5px 0; }
    .modal-link { display: block; margin-top: 10px; font-size: 18px; color: blue; text-decoration: underline; }
    .close-modal { position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 20px; }
    
    /* Google Books Summary Finder styles */
    input { padding: 8px; width: 200px; }
    button { padding: 8px; margin-left: 5px; cursor: pointer; }
    #summary { margin-top: 20px; font-style: italic; }
  </style>
</head>
<body>
  <h2>MARC Tools</h2>
  
  <!-- Tabs -->
  <div class="tabs" role="tablist">
    <div class="tab active" data-tab="bib-formats" role="tab" aria-selected="true" tabindex="0">Bib Formats</div>
    <div class="tab" data-tab="marc-builder" role="tab" aria-selected="false" tabindex="0">650 Builder</div>
    <div class="tab" data-tab="book-summary" role="tab" aria-selected="false" tabindex="0">520 Search</div>
    <div class="tab" data-url="https://www.librarything.com/mds" role="tab" tabindex="0">MDS</div>
    <div class="tab" data-url="https://www.loc.gov/aba/cataloging/tools/" role="tab" tabindex="0">LCSH</div>
    <div class="tab" data-url="https://authorities.loc.gov/webvoy.htm" role="tab" tabindex="0">LOC Authorities</div>
  </div>
  
  <!-- Bib Formats Tab -->
  <div id="bib-formats" class="tab-content active" style="position: relative; height: 80vh; overflow: auto;" role="tabpanel">
    <iframe id="bib-frame" src="https://www.oclc.org/bibformats/en/about.html" width="100%" height="100%" style="border: none;"></iframe>
  </div>
  
  <!-- MARC Builder Tab -->
  <div id="marc-builder" class="tab-content" role="tabpanel">
    <h3>LCSH 650 MARC Builder</h3>
    <div class="builder-container">
      <input type="text" id="field1" class="builder-input" placeholder="Main Term">
      <div class="dropdown" data-index="0">+</div>
      <input type="text" id="field2" class="builder-input" placeholder="Subdivision">
      <div class="dropdown" data-index="1">+</div>
      <input type="text" id="field3" class="builder-input" placeholder="Subdivision">
      <div class="dropdown" data-index="2">+</div>
      <input type="text" id="field4" class="builder-input" placeholder="Subdivision">
    </div>
  
    <div id="dropdownMenu" class="dropdown-menu">
      <div data-value="">— None —</div>
      <div data-value="|v">|v - Form subdivision</div>
      <div data-value="|x">|x - General subdivision</div>
      <div data-value="|y">|y - Chronological subdivision</div>
      <div data-value="|z">|z - Geographic subdivision</div>
    </div>
    <div>
      <button id="copyMARC" style="margin-bottom: 20px;">Copy 650 MARC Field</button>
    </div>
  
    <!-- Search Bar -->
    <div class="search-container">
      <input type="text" id="searchInput1" placeholder="Search Library of Congress">
      <button id="searchButton1">Search</button>
    </div>
  
    <!-- Results Section -->
    <div id="results" class="results"></div>
  
    <!-- More Info Modal -->
    <div id="infoModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-content">
        <span class="close-modal" tabindex="0">&times;</span>
        <h3 id="modalTitle"></h3>
        <p><strong>Scope Note:</strong> <span id="modalScope"></span></p>
        <p><strong>Broader Term:</strong> <span id="modalBroader"></span></p>
        <p><strong>Source:</strong> <span id="modalSource"></span></p>
        <p><strong>Classification:</strong> <span id="modalType"></span></p>
        <a id="infoLink" class="modal-link" href="#" target="_blank">Open in New Tab</a>
      </div>
    </div>
    <!-- FAST OCLC Search Modal Trigger -->
    <div style="margin-top: 20px; text-align: left;">
      <button id="openFastModal" style="margin-top: 40px; margin-bottom: 20px;">Search FAST</button>
      <div>
        <small>(use 650 _7 {subject}.|2fast)</small>
      </div>
    </div>
    <!-- FAST OCLC Modal -->
    <div id="fastModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="fastModalTitle">
      <div class="modal-content" style="width: 80%; height: 80vh; position: relative;">
        <span class="close-modal" tabindex="0" style="position: absolute; top: 10px; right: 15px; font-size: 24px;">&times;</span>
        <h3 id="fastModalTitle" style="text-align: center;">FAST OCLC Search</h3>
        <iframe src="https://fast.oclc.org/searchfast/?&limit=keywords&facet=topic&query=&sort=usage+desc&start=0#&fullview=null&sep=null" width="100%" height="90%" style="border: none;"></iframe>
      </div>
    </div>
  </div>
  
  <!-- Book Summary Finder Tab -->
  <div id="book-summary" class="tab-content" role="tabpanel">
    <h3>Google Books ISBN Summary Search</h3>
    <input type="text" id="isbn" placeholder="Enter ISBN" />
    <button id="fetchSummary">Search</button>
    <p id="summary"></p>
    <button id="copySummaryBtn" style="display:none;">Copy Summary</button>
  </div>
  
  <script>
    // Global variable for dropdown index
    let activeDropdownIndex = null;
  
    // Function to switch tabs
    function switchTab(tabId) {
      const tabs = document.querySelectorAll('.tabs .tab');
      const contents = document.querySelectorAll('.tab-content');
      tabs.forEach(tab => {
        tab.classList.remove('active');
        if(tab.getAttribute('data-tab')) {
          tab.setAttribute('aria-selected', 'false');
        }
      });
      contents.forEach(content => content.classList.remove('active'));
  
      const activeTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
      if(activeTab) {
        activeTab.classList.add('active');
        activeTab.setAttribute('aria-selected', 'true');
      }
      document.getElementById(tabId).classList.add('active');
    }
  
    // MARC Builder Functions
  
    function searchLOC(inputId) {
      const query = document.getElementById(inputId).value;
      if (!query) return;
  
      fetch(`https://id.loc.gov/authorities/subjects/suggest2/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          const resultsDiv = document.getElementById("results");
          resultsDiv.innerHTML = "";
  
          data.hits.forEach(hit => {
            const div = document.createElement("div");
            div.className = "result-item";
  
            const labelSpan = document.createElement("span");
            labelSpan.textContent = hit.suggestLabel;
            labelSpan.style.cursor = "pointer";
            labelSpan.addEventListener("click", () => populateBuilder(hit.suggestLabel));
  
            const moreInfoSpan = document.createElement("span");
            moreInfoSpan.textContent = "More Info";
            moreInfoSpan.className = "more-info";
            moreInfoSpan.addEventListener("click", () => openModal(hit));
  
            div.appendChild(labelSpan);
            div.appendChild(moreInfoSpan);
            resultsDiv.appendChild(div);
          });
        })
        .catch(error => console.error("Error fetching data:", error));
    }
  
    function handleSearchKeyPress(event, inputId) {
      if (event.key === "Enter") {
        searchLOC(inputId);
      }
    }
  
    function populateBuilder(subject) {
      const parts = subject.split("--");
      document.getElementById("field1").value = parts[0] || "";
      document.getElementById("field2").value = parts[1] || "";
      document.getElementById("field3").value = parts[2] || "";
      document.getElementById("field4").value = parts[3] || "";
    }
  
    function toggleDropdown(event, index) {
      activeDropdownIndex = index;
      const menu = document.getElementById("dropdownMenu");
      const rect = event.target.getBoundingClientRect();
      menu.style.display = "block";
      menu.style.left = rect.left + "px";
      menu.style.top = rect.bottom + "px";
      event.stopPropagation();
    }
  
    // Close dropdown when clicking an item
    document.getElementById("dropdownMenu").addEventListener("click", function(event) {
      const value = event.target.getAttribute("data-value");
      if (value !== null && activeDropdownIndex !== null) {
        const dropdowns = document.querySelectorAll(".dropdown");
        dropdowns[activeDropdownIndex].textContent = value || "+";
        this.style.display = "none";
      }
    });
  
    function copyMARC() {
      const field1 = document.getElementById("field1").value;
      const field2 = document.getElementById("field2").value;
      const field3 = document.getElementById("field3").value;
      const field4 = document.getElementById("field4").value;
      const dropdowns = document.querySelectorAll(".dropdown");
  
      const sub1 = dropdowns[0].textContent.includes("|") ? dropdowns[0].textContent : "";
      const sub2 = dropdowns[1].textContent.includes("|") ? dropdowns[1].textContent : "";
      const sub3 = dropdowns[2].textContent.includes("|") ? dropdowns[2].textContent : "";
  
      const finalText = `${field1}${sub1}${field2}${sub2}${field3}${sub3}${field4}.`.trim();
      navigator.clipboard.writeText(finalText);
      alert("Copied: " + finalText);
    }
  
    function openModal(hit) {
      document.getElementById("modalTitle").innerText = hit.suggestLabel || "No Title Available";
      document.getElementById("modalScope").innerText = hit.more?.scopenote || "No scope note available.";
      document.getElementById("modalBroader").innerText = hit.more?.broader || "No broader term available.";
      document.getElementById("modalSource").innerText = hit.more?.source || "No source information available.";
      document.getElementById("modalType").innerText = hit.more?.rdftype || "No classification available.";
      document.getElementById("infoLink").href = hit.uri;
      document.getElementById("infoModal").style.display = "flex";
    }
  
    // Google Books Summary Finder Functions
  
    function fetchSummary() {
      const isbn = document.getElementById("isbn").value.trim();
      if (!isbn) return;
  
      fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${encodeURIComponent(isbn)}`)
        .then(response => response.json())
        .then(data => {
          const book = data.items?.find(item =>
            item.volumeInfo.industryIdentifiers?.some(id => id.identifier === isbn)
          );
  
          if (book && book.volumeInfo.description) {
            let summaryText = book.volumeInfo.description.trim();
            if (!summaryText.startsWith("\"")) {
              summaryText = `"${summaryText}"`;
            }
            summaryText = summaryText.replace(/--$/, "").trim() + " --Google Books";
            document.getElementById("summary").innerText = summaryText;
            document.getElementById("copySummaryBtn").style.display = "inline-block";
          } else {
            document.getElementById("summary").innerText = "No summary available.";
            document.getElementById("copySummaryBtn").style.display = "none";
          }
        })
        .catch(error => {
          console.error("Error fetching data:", error);
          document.getElementById("summary").innerText = "Error fetching summary.";
          document.getElementById("copySummaryBtn").style.display = "none";
        });
    }
  
    function handleSummaryKeyPress(event) {
      if (event.key === "Enter") {
        fetchSummary();
      }
    }
  
    function copySummary() {
      const summaryText = document.getElementById("summary").innerText;
      navigator.clipboard.writeText(summaryText).then(() => {
        alert("Summary copied to clipboard!");
      });
    }
  
    function openFastModal() {
      document.getElementById("fastModal").style.display = "flex";
    }
  
    // Adjust iframe height for bib formats
    function adjustIframeHeight() {
      const iframe = document.getElementById("bib-frame");
      iframe.style.height = window.innerHeight * 0.8 + "px";
    }
  
    // Set up event listeners after DOM is loaded
    document.addEventListener("DOMContentLoaded", function() {
      // Tab click events
      document.querySelectorAll('.tabs .tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const url = this.getAttribute('data-url');
          if(url) {
            window.open(url, '_blank');
          } else {
            switchTab(this.getAttribute('data-tab'));
          }
        });
      });
  
      // MARC Builder search events
      document.getElementById("searchButton1").addEventListener("click", () => searchLOC("searchInput1"));
      document.getElementById("searchInput1").addEventListener("keydown", (event) => handleSearchKeyPress(event, "searchInput1"));
  
      // Bind dropdown click events
      document.querySelectorAll('.builder-container .dropdown').forEach(dropdown => {
        dropdown.addEventListener("click", function(event) {
          const index = parseInt(this.getAttribute("data-index"), 10);
          toggleDropdown(event, index);
        });
      });
  
      // Global click to close dropdown if clicking outside
      document.addEventListener("click", (e) => {
        const menu = document.getElementById("dropdownMenu");
        if (!menu.contains(e.target)) {
          menu.style.display = "none";
        }
      });
  
      // Copy MARC button event
      document.getElementById("copyMARC").addEventListener("click", copyMARC);
  
      // FAST modal trigger event
      document.getElementById("openFastModal").addEventListener("click", openFastModal);
  
      // Book Summary events
      document.getElementById("fetchSummary").addEventListener("click", fetchSummary);
      document.getElementById("copySummaryBtn").addEventListener("click", copySummary);
      document.getElementById("isbn").addEventListener("keydown", handleSummaryKeyPress);
  
      // Close modal events for any element with class "close-modal"
      document.querySelectorAll('.modal .close-modal').forEach(btn => {
        btn.addEventListener("click", function() {
          this.closest('.modal').style.display = "none";
        });
      });
  
      // Adjust iframe height on load and on resize
      adjustIframeHeight();
      window.addEventListener("resize", adjustIframeHeight);
    });
  </script>
</body>
</html>

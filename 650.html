<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MARC 650 Subject Finder</title>
  <style>
    /* Your existing styles... */
  </style>
  <script>
    function log(message) {
      let logContainer = document.getElementById("log-container");
      logContainer.innerText += message + "\n";
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function copyLog() {
      let logContainer = document.getElementById("log-container");
      let tempTextArea = document.createElement("textarea");
      tempTextArea.value = logContainer.innerText;
      document.body.appendChild(tempTextArea);
      tempTextArea.select();
      document.execCommand("copy");
      document.body.removeChild(tempTextArea);
      alert("Log copied to clipboard!");
    }

    async function fetchMARC(keyword = null) {
      let inputField = document.getElementById("keyword");
      let searchTerm = keyword || inputField.value.trim();
      let resultsContainer = document.getElementById("results");
      let relatedContainer = document.getElementById("related-results");
      let synonymsContainer = document.getElementById("synonyms-list");
      let oclcContainer = document.getElementById("oclc-results");

      resultsContainer.innerHTML = "";
      relatedContainer.innerHTML = "";
      synonymsContainer.innerHTML = "";
      oclcContainer.innerHTML = "";

      if (!searchTerm) {
        resultsContainer.innerText = "Please enter a keyword.";
        return;
      }

      inputField.value = searchTerm; 

      let foundTerms = new Map();
      let relatedTerms = new Map();
      let synonyms = new Set();
      let oclcTerms = new Map();

      log(`Searching for: ${searchTerm}`);

      await fetchSynonyms(searchTerm, synonyms);
      await fetchLCSHSubjects(searchTerm, foundTerms);

      for (let synonym of synonyms) {
        await fetchLCSHSubjects(synonym, relatedTerms);
      }

      await fetchOCLCSubjects(searchTerm, oclcTerms);

      let output = "<ul>";
      if (foundTerms.size > 0) {
        foundTerms.forEach((link, subject) => {
          output += `<li><a href="${link}" target="_blank">650 _0 $a ${subject} $2 lcsh</a></li>`;
        });
      } else {
        output += "<li>No exact LCSH terms found.</li>";
      }
      output += "</ul>";
      resultsContainer.innerHTML = output;

      if (relatedTerms.size > 0) {
        let relatedOutput = `<div class="related-section"><div class="section-title">Related Subjects:</div><ul>`;
        relatedTerms.forEach((link, subject) => {
          relatedOutput += `<li><a href="${link}" target="_blank">650 _0 $a ${subject} $2 lcsh</a></li>`;
        });
        relatedOutput += "</ul></div>";
        relatedContainer.innerHTML = relatedOutput;
      } else {
        relatedContainer.innerHTML = "<div class='related-section'>No related subjects found.</div>";
      }

      if (oclcTerms.size > 0) {
        let oclcOutput = `<div class="oclc-section"><div class="section-title">OCLC FAST Results:</div><ul>`;
        oclcTerms.forEach((link, subject) => {
          oclcOutput += `<li><a href="${link}" target="_blank">650 _7 $a ${subject} $2 fast</a></li>`; 
        });
        oclcOutput += "</ul></div>";
        oclcContainer.innerHTML = oclcOutput;
      } else {
        oclcContainer.innerHTML = "<div class='oclc-section'>No OCLC FAST terms found.</div>";
      }

      if (synonyms.size > 0) {
        let synonymsOutput = `<div class="synonyms-section"><div class="section-title">Try These Synonyms:</div><ul>`;
        synonyms.forEach(term => {
          synonymsOutput += `<li><a href="#" onclick="fetchMARC('${term}')">${term}</a></li>`;
        });
        synonymsOutput += "</ul></div>";
        synonymsContainer.innerHTML = synonymsOutput;
      }
    }

    async function fetchSynonyms(keyword, synonyms) {
      let url = `https://api.datamuse.com/words?ml=${encodeURIComponent(keyword)}&max=5`;
      try {
        let response = await fetch(url);
        let data = await response.json();
        data.forEach(term => synonyms.add(term.word));
        log(`Found synonyms: ${[...synonyms].join(", ")}`);
      } catch (error) {
        log("Error fetching synonyms: " + error);
      }
    }

    async function fetchLCSHSubjects(term, storageMap) {
      let url = `https://id.loc.gov/authorities/subjects/suggest/?q=${encodeURIComponent(term)}`;
      try {
        let response = await fetch(url);
        let data = await response.json();
        if (data[1] && data[3]) {
          data[1].forEach((subject, index) => {
            let link = data[3][index];
            storageMap.set(subject, link);
          });
        }
        log(`Fetched LCSH terms for ${term}: ${[...storageMap.keys()].join(", ")}`);
      } catch (error) {
        log("Error fetching LCSH subjects: " + error);
      }
    }

    async function fetchOCLCSubjects(term, storageMap) {
      let url = `https://fast.oclc.org/search?query=cql.any+%3D+%22${encodeURIComponent(term)}%22&httpAccept=application/xml`;
      try {
        let response = await fetch(url);
        let text = await response.text();
        log(`Raw OCLC FAST Response: ${text}`);

        let parser = new DOMParser();
        let xmlDoc = parser.parseFromString(text, "application/xml");
        let datafields = xmlDoc.getElementsByTagName("mx:datafield");

        Array.from(datafields).forEach(datafield => {
          let tag = datafield.getAttribute("tag");
          let subfields = datafield.getElementsByTagName("mx:subfield");
          
          let subject = "";
          let fastID = "";
          let uri = "";
          let isSubject = false;

          if (tag === "150" || tag === "110" || tag === "111") {
            isSubject = true;
          }

          Array.from(subfields).forEach(subfield => {
            let code = subfield.getAttribute("code");
            let value = subfield.textContent.trim();

            if (code === "a") {
              subject = value;
            } else if (code === "0") {
              fastID = value;
            } else if (code === "2" && value === "fast") {
              isSubject = true;
            } else if (code === "a" && tag === "024") {
              uri = value;
            }
          });

          if (isSubject && subject) {
            if (!uri && fastID) {
              uri = `http://id.worldcat.org/fast/${fastID}`;
            }
            if (uri) {
              storageMap.set(subject, uri);
            }
          }
        });

        log(`Fetched OCLC FAST terms for ${term}: ${[...storageMap.keys()].join(", ")}`);
      } catch (error) {
        log("Error fetching OCLC FAST subjects: " + error);
      }
    }
  </script>
</head>

<body>
  <h2>MARC 650 Subject Finder</h2>
  <input type="text" id="keyword" placeholder="Enter book topic">
  <button onclick="fetchMARC()">Find Subjects</button>

  <div class="results-container">
    <h3>LOC Exact Matches</h3>
    <div id="results"></div>
    <h3>Related LOC Subjects</h3>
    <div id="related-results"></div>
    <h3>OCLC FAST Results</h3>
    <div id="oclc-results"></div>
    <h3>Synonyms</h3>
    <div id="synonyms-list"></div>
  </div>
  <div id="log-container"></div>
  <button id="copy-log-button" onclick="copyLog()">Copy Log</button>
</body>

</html>
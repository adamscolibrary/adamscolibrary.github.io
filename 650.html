<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MARC 650 Subject Finder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 50px;
    }

    input {
      width: 80%;
      padding: 10px;
      margin: 10px;
    }

    button {
      padding: 10px;
      cursor: pointer;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      padding: 5px;
      border-bottom: 1px solid #ddd;
    }

    li a {
      text-decoration: none;
      color: blue;
      cursor: pointer;
    }

    li a:hover {
      text-decoration: underline;
    }

    .section-title {
      font-size: 18px;
      font-weight: bold;
      margin-top: 20px;
    }

    .related-section,
    .synonyms-section,
    .oclc-section {
      font-size: 16px;
      color: #555;
      margin-top: 20px;
      border-top: 2px solid #ddd;
      padding-top: 15px;
    }

    .results-container {
      text-align: left;
      max-width: 600px;
      margin: 0 auto;
    }

    #log-container {
      margin-top: 30px;
      padding: 10px;
      border: 1px solid #ddd;
      max-height: 200px;
      overflow-y: auto;
      background-color: #f4f4f4;
      font-family: monospace;
    }

    #copy-log-button {
      margin-top: 10px;
      padding: 5px 10px;
    }
  </style>
  <script>
    async function fetchMARC(keyword = null) {
      let inputField = document.getElementById("keyword");
      let searchTerm = keyword || inputField.value.trim();
      let resultsContainer = document.getElementById("results");
      let relatedContainer = document.getElementById("related-results");
      let synonymsContainer = document.getElementById("synonyms-list");
      let oclcContainer = document.getElementById("oclc-results");
      let logContainer = document.getElementById("log-container");

      resultsContainer.innerHTML = "";
      relatedContainer.innerHTML = "";
      synonymsContainer.innerHTML = "";
      oclcContainer.innerHTML = "";
      logContainer.innerHTML = "";

      if (!searchTerm) {
        resultsContainer.innerText = "Please enter a keyword.";
        return;
      }

      inputField.value = searchTerm; // Update input field if a synonym was clicked

      let foundTerms = new Map();
      let relatedTerms = new Map();
      let synonyms = new Set();
      let oclcTerms = new Map();

      // Fetch synonyms first
      await fetchSynonyms(searchTerm, synonyms);

      // Fetch exact matches for the original search term from LOC
      await fetchLCSHSubjects(searchTerm, foundTerms);

      // Fetch related subjects using synonyms (to populate related subjects)
      for (let synonym of synonyms) {
        await fetchLCSHSubjects(synonym, relatedTerms);
      }

      // Fetch OCLC FAST subjects
      await fetchOCLCSubjects(searchTerm, oclcTerms, logContainer);

      // Display Exact Matches (LOC)
      let output = "<ul>";
      if (foundTerms.size > 0) {
        foundTerms.forEach((link, subject) => {
          output += `<li><a href="${link}" target="_blank">650 _0 $a ${subject} $2 lcsh</a></li>`;
        });
      } else {
        output += "<li>No exact LCSH terms found.</li>";
      }
      output += "</ul>";
      resultsContainer.innerHTML = output;

      // Display Related Subjects (LOC)
      if (relatedTerms.size > 0) {
        let relatedOutput = `<div class="related-section"><div class="section-title">Related Subjects:</div><ul>`;
        relatedTerms.forEach((link, subject) => {
          relatedOutput += `<li><a href="${link}" target="_blank">650 _0 $a ${subject} $2 lcsh</a></li>`;
        });
        relatedOutput += "</ul></div>";
        relatedContainer.innerHTML = relatedOutput;
      } else {
        relatedContainer.innerHTML = "<div class='related-section'>No related subjects found.</div>";
      }

      // Display OCLC FAST Results
      if (oclcTerms.size > 0) {
        let oclcOutput = `<div class="oclc-section"><div class="section-title">OCLC FAST Results:</div><ul>`;
        oclcTerms.forEach((link, subject) => {
          oclcOutput += `<li><a href="${link}" target="_blank">650 _0 $a ${subject} $2 fast</a></li>`;
        });
        oclcOutput += "</ul></div>";
        oclcContainer.innerHTML = oclcOutput;
      } else {
        oclcContainer.innerHTML = "<div class='oclc-section'>No OCLC FAST terms found.</div>";
      }

      // Display Synonyms as Clickable Links
      if (synonyms.size > 0) {
        let synonymsOutput = `<div class="synonyms-section"><div class="section-title">Try These Synonyms:</div><ul>`;
        synonyms.forEach(term => {
          synonymsOutput += `<li><a href="#" onclick="fetchMARC('${term}')">${term}</a></li>`;
        });
        synonymsOutput += "</ul></div>";
        synonymsContainer.innerHTML = synonymsOutput;
      }
    }

    // Fetch synonyms from Datamuse API
    async function fetchSynonyms(keyword, synonyms) {
      let url = `https://api.datamuse.com/words?ml=${encodeURIComponent(keyword)}&max=5`;
      try {
        let response = await fetch(url);
        let data = await response.json();
        data.forEach(term => synonyms.add(term.word));
      } catch (error) {
        log("Error fetching synonyms: " + error);
      }
    }

    // Fetch LCSH subjects
    async function fetchLCSHSubjects(term, storageMap) {
      let url = `https://id.loc.gov/authorities/subjects/suggest/?q=${encodeURIComponent(term)}`;
      try {
        let response = await fetch(url);
        let data = await response.json();
        if (data[1] && data[3]) {
          data[1].forEach((subject, index) => {
            let link = data[3][index];
            storageMap.set(subject, link);
          });
        }
      } catch (error) {
        log("Error fetching LCSH subjects: " + error);
      }
    }

    // Fetch OCLC FAST subjects
    async function fetchOCLCSubjects(term, storageMap, logContainer) {
      let url = `http://fast.oclc.org/search?query=cql.any+%3D+%22${encodeURIComponent(term)}%22&httpAccept=application/xml`;
      try {
        let response = await fetch(url);
        let text = await response.text();

        // Parse the XML response
        let parser = new DOMParser();
        let xmlDoc = parser.parseFromString(text, "application/xml");
        let datafields = xmlDoc.getElementsByTagName("mx:datafield");

        // Iterate over datafields to find subjects and URLs
        Array.from(datafields).forEach(datafield => {
          let subject = "";
          let subjectLink = "";

          // Find subfield "a" for subject
          let subjectSubfield = datafield.querySelector("mx\\:subfield[code='a'], subfield[code='a']");
          if (subjectSubfield) {
            subject = subjectSubfield.textContent.trim();
          }

          // Find subfield "a" for URL
          let urlSubfield = datafield.querySelector("mx\\:subfield[code='a'], subfield[code='a']");
          if (urlSubfield && urlSubfield.textContent.includes("http://")) {
            subjectLink = urlSubfield.textContent.trim();
          }

          // If a subject and URL were found, add them to the map
          if (subject && subjectLink) {
            storageMap.set(subject, subjectLink);
          }
        });

        log("Fetched OCLC FAST terms for " + term + ": " + [...storageMap.keys()].join(", "), logContainer);
      } catch (error) {
        log("Error fetching OCLC FAST terms: " + error, logContainer);
      }
    }

    // Log helper function
    function log(message, logContainer = document.getElementById("log-container")) {
      let logEntry = document.createElement("div");
      logEntry.textContent = message;
      logContainer.appendChild(logEntry);
    }

    // Copy log to clipboard
    function copyLog() {
      let logContainer = document.getElementById("log-container");
      let range = document.createRange();
      range.selectNode(logContainer);
      window.getSelection().removeAllRanges();
      window.getSelection().addRange(range);
      document.execCommand("copy");
      alert("Log copied to clipboard.");
    }

    // Initialize the function when the page loads
    document.addEventListener("DOMContentLoaded", () => {
      const searchButton = document.getElementById("search-button");
      searchButton.addEventListener("click", () => fetchMARC());
    });
  </script>
</head>

<body>
  <h1>MARC 650 Subject Finder</h1>

  <!-- Input Field -->
  <input type="text" id="keyword" placeholder="Enter a keyword..." />

  <!-- Search Button -->
  <button id="search-button">Search</button>

  <!-- Display Results -->
  <div id="results" class="results-container"></div>
  <div id="related-results" class="results-container"></div>
  <div id="oclc-results" class="results-container"></div>
  <div id="synonyms-list" class="results-container"></div>

  <!-- Log Section -->
  <div id="log-container"></div>
  <button id="copy-log-button" onclick="copyLog()">Copy Log</button>
</body>

</html>